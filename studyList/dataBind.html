<!DOCTYPE html>
<html lang="zh">
	<head>
		<meta http-equiv="content-type" content="text/html; charset=utf-8" />
		<title>hifve数据绑定篇</title>
		<link href="../lib/toc/style/github-bf51422f4bb36427d391e4b75a1daa083c2d840e.css" media="all" rel="stylesheet" type="text/css" />
		<link href="../lib/toc/style/github2-d731afd4f624c99a4b19ad69f3083cd6d02b81d5.css" media="all" rel="stylesheet" type="text/css" />
		<link href="../lib/toc/css/zTreeStyle/zTreeStyle.css" media="all" rel="stylesheet" type="text/css" />
		<link rel="stylesheet" type="text/css" href="../css/common.css"/>
	</head>

	<body>
		<div>
			<div style='width:25%;'>
				<ul id="tree" class="ztree" style='width:100%'>

				</ul>
			</div>
			<div id='readme' style='width:70%;margin-left:20%;'>
				<article class='markdown-body'>
					<h1>数据绑定</h1>
					<h2>概述</h2>
					<p>在这个教程中，我们将学习hifive数据模型中用于支持数据绑定的机制。
在hifive中，数据绑定是指，通过在JavaScript中对dataModel的操作来实现画面相应部分自动变更的机制。
通过hifive中的数据绑定，可以让编码者只用将精力集中在JavaScript上，从而减少了代码量。
同时，因为可以对视图的哪一部分对应着显示什么数据进行声明，所以也使得视图设计和代码分离开来。</p>
					<h1>基本使用方法</h1>
					<h2>数据绑定</h2>
					<p>进行数据绑定时，首先编写要绑定的HTML，然后将HTML中的子元素和对应的对象进行绑定。</p>
					<pre><code>&lt;div id="bindtest"&gt;
    &lt;h1 data-h5-bind="title"&gt;&lt;/h1&gt;
    &lt;div data-h5-context="item"&gt;
        ID: &lt;span data-h5-bind="id"&gt;&lt;/span&gt;
        Name: &lt;span data-h5-bind="name"&gt;&lt;/span&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
					<p>比如上面的HTML，可以使用bind()方法来对视图中的某个class和对应的对象进行绑定。</p>
					<pre><code>// 第一参数(选择器、DOM元素、jQuery对象)
// 第2引数为绑定的对象
h5.core.view.bind('#bindtest', {
    title: '数据绑定测试', // data-h5-bind="title" 绑定这个元素

    // data-h5-context="item" 的元素内，指定使用对象。
    item: {
        id: '0001',      // 绑定data-h5-context="item" 元素的子元素data-h5-bind="id"
        name: 'taro'     // ↑同上
    }
});</code></pre>
					<p><strong>得出结果</strong></p>
					<pre><code>&lt;div id="bindtest"&gt;
    &lt;h1>数据绑定测试&lt;/h1&gt;
    &lt;div&gt;
        ID: &lt;span&gt;0001&lt;/span&gt;
        Name: &lt;span&gt;taro&lt;/span&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
					<p>如上所示，将属性data-h5-bind指定为对象中的属性名，即可将该对象与HTML视图绑定起来。
包含有多个层级关系时，父元素指定为data-h5-context，子元素指定为data-h5-bind即可。</p>
					<pre><code>h5.core.view.bind('#bindtest', {
    title: '数据绑定测试',

    parentItem: {
        childItem: {
            grandChildItem: {
                name: 'GrandChild'
            },
            name: 'Child'
        },
        childItem2: {
            name: 'Child2'
        }
        name: 'Parent'
    }
});
&lt;div id="bindtest"&gt;
    &lt;h1 data-h5-bind="title"&gt;&lt;/h1&gt;

    &lt;div data-h5-context="parentItem"&gt;
        Name:&lt;span data-h5-bind="name"&gt;&lt;/span&gt;          &lt;!-- Parent --&gt;
        &lt;div data-h5-context="childItem"&gt;
            Name:&lt;span data-h5-bind="name"&gt;&lt;/span&gt;      &lt;!-- Child --&gt;
            &lt;div data-h5-context="grandChildItem"&gt;
                Name:&lt;span data-h5-bind="name"&gt;&lt;/span&gt; &lt;!-- GrandChild --&gt;
            &lt;/div&gt;
        &lt;/div&gt;
        &lt;div data-h5-context="childItem2"&gt;
            Name:&lt;span data-h5-bind="name"&gt;&lt;/span&gt;      &lt;!-- Child2 --&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
					<h2>dataItem的绑定</h2>
					<p>像刚才的例子一样，我们可以将item改为dataItem来进行数据绑定。</p>
					<pre><code>var manager = h5.core.data.createManager('TestManager');

// 制成携带id和name的model
var model = manager.createModel({
    name: 'NameModel',
    schema: {
        id: {
            id: true
        },
        name: {
            type: 'string'
        }
    }
});

// 制成id为002、name为jiro的item
var item = model.create({
        id: '002',
        name: 'jiro'
});

// 绑定view
h5.core.view.bind('#bindtest', {
    title: '数据绑定测试',

    // 指定dataItem
    item: item
});</code></pre>
					<p>HTML的部分与先前一样。</p>
					<pre><code>最终结果

&lt;div id="bindtest"&gt;
    &lt;h1&gt;数据绑定测试&lt;/h1&gt;
    &lt;div&gt;
        ID: &lt;span&gt;0002&lt;/span&gt;
        Name: &lt;span&gt;jiro&lt;/span&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
					<p>用dataItem进行绑定时，将这个dataItem中的属性名用data-h5-bind的值来指定。与用对象进行绑定的做法几乎一样。</p>
					<h3>dataItem值的变化</h3>
					<p>当用dataItem绑定后，如果dataItem的值变化时，对应绑定的元素值也会自动改写。
如上面的例子，改变item中name的值。</p>
					<pre><code>item.set('name', 'sabrow');
在视图中可以立刻表现出来。

&lt;div id="bindtest"&gt;
    &lt;h1&gt;数据绑定测试&lt;/h1&gt;
    &lt;div&gt;
        ID: &lt;span&gt;0002&lt;/span&gt;
        Name: &lt;span&gt;sabrow&lt;/span&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
					<h3>数据绑定的多重使用</h3>
					<p>在使用数据绑定功能时，不能将同一个对象同时与父子关系的两个元素相绑定。
但是，可以像平时一样使用jQuery等进行值的读取。
并且，可以同时绑定没有父子元素的多个元素。</p>
					<p><strong>实例</strong></p>
					<p>如下面的HTML中，在已经与div#bindTarget元素绑定了的情况下，
不能再与其子元素div#child或者div#grandChild进行绑定了。
但是，由于div#another和div#bindTarget是兄弟关系，可以同时进行数据绑定。</p>
<pre><code><body>
  &lt;div id="bindTarget"&gt;  &lt;!-- 这个元素作为根元素适合绑定--&gt;
    &lt;div id="child"&gt;
      &lt;div id="grandChild"&gt;
      &lt;/div&gt;
    &lt;/div&gt;
  &lt;/div&gt;

  &lt;div id="another"&gt;
  &lt;/div&gt;
&lt;/body&gt;</code></pre>
					<h2>数组的绑定</h2>
					<h3>循环绑定</h3>
					<p>数据绑定，可实现特定元素自动循环生成并在视图中显示。
通常可以使用数组、或是ObervableArray对象，
将数组中包含的元素自动遍历生成并在视图中显示。
并且，使用ObervableArray时，还可以调用push()、splice()等方法，来对数组元素进行操作，从而改变视图。
使用自动遍历生成功能时，遍历部分的父元素需要指定为data-h5-loop-context的属性值。
此时，只是知道了该数组元素个数，即确定了遍历循环的次数。
还需要用data-h5-bind属性来绑定数组中每个元素的值。</p>
					<h3>普通绑定</h3>
					<p>用普通数组作为数据源时，数组长度变化时，视图不会发生改变。
想要视图随着数组动态改变时，请使用ObservableArray作为数据源。</p>
					<pre><code>&lt;div id="bindtest"&gt;
    &lt;div data-h5-loop-context="items"&gt;
        &lt;div&gt;
            ID: &lt;span data-h5-bind="id"&gt;&lt;/span&gt;     &lt;!-- items[i].id 的意思 --&gt;
            Name: &lt;span data-h5-bind="name"&gt;&lt;/span&gt; &lt;!-- items[i].name 的意思--&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/div&gt;</code></pre>
					<pre><code>var ary = [{
    id: '001',
    name: 'taro'
}, {
    id: '002',
    name: 'jiro'
}];

h5.core.view.bind($('#bindtest'), {
    items: ary
});</code></pre>
					<p>显示结果如下：</p>
					<pre><code>ID: 001 Name: taro
ID: 002 Name: jiro</code></pre>
					<h3>ObservableArray的绑定</h3>
					<p>和普通数组的绑定方式完全相同。</p>
					<pre><code>// ObservableArray的制作
var obsAry = h5.core.data.createObservableArray();

obsAry.set(0, { id: '001', name: 'taro' });
obsAry.set(1, { id: '002', name: 'jiro' });

h5.core.view.bind($('#bindtest'), {
    items: obsAry
});</code></pre>
					<p>HTML中的显示结果也和普通数组一样，
但是，使用ObservableArray，数组的变化可以自动反映到视图中。</p>
					<pre><code>obsAry.push({
    id: '005',
    name: 'goro'
});</code></pre>
					<p>显示结果</p>
					<pre><code>ID: 001 Name: taro
ID: 002 Name: jiro
ID: 005 Name: goro</code></pre>
					<p>想要对数组元素进行操作是，请使用get()和set()方法。</p>
					<h1>todo应用</h1>
					<h2>概要</h2>
					<p>这一章节，我们利用hifive的数据模型和数据绑定功能，来制作一个TODO管理小应用 。
这个小应用包含了显示TODO一览，以及每个TODO的详细内容。
每一行一览包含：用来更改完成状态的checkbox、以及该TODO的内容。
详细画面中会显示详细信息、登录日期和现在的完成状态，也可以对内容和状态进行更新。
并且，可以通过一个删除按钮来删除当前显示的这一条TODO记录。<a href="../sample/todo.rar">点击这里下载完整项目包</a></p>
					<p><strong>动作确认</strong></p>
					<p>可以点击<a href="../sample/todo/todo.html">这里</a>查看该应用。</p>
					<img src="../images/todo.png" alt="todo管理" />
					<h2>创建数据模型</h2>
					<h3>概要</h3>
					<p>TODO的信息使用DataModel来定义。
这一页中将对例子的todoModel.js代码进行说明。</p>
					<h3>定义schema</h3>
					<p>用来管理TODO数据的ToDoModel的schema如下进行定义。</p>
					<table>
						<thead>
							<tr>
								<th>属性名</th>
								<th>说明</th>
								<th>类型</th>
								<th>备注</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>id</td>
								<td>该schema的主键</td>
								<td>Number</td>
								<td>必须定义</td>
							</tr>
							<tr>
								<td>status</td>
								<td>保存是否完成的状态</td>
								<td>Boolean</td>
								<td>已完成为true，未完成为false</td>
							</tr>
							<tr>
								<td>checked</td>
								<td>状态(画面显示用)</td>
								<td>String</td>
								<td>由status来决定。status为true时"checked"，其他情况都为null</td>
							</tr>
							<tr>
								<td>content</td>
								<td>TODO内容</td>
								<td>String</td>
								<td></td>
							</tr>
							<tr>
								<td>contentStyle</td>
								<td>TODO内容的CSS样式(画面显示用)</td>
								<td>String</td>
								<td>由status来决定。status为true时"line-through"，其他情况都为空</td>
							</tr>
							<tr>
								<td>insertDate</td>
								<td>插入日期</td>
								<td>Number</td>
								<td>毫秒</td>
							</tr>
							<tr>
								<td>ymdhms</td>
								<td>插入详细日期(画面显示用)</td>
								<td>String</td>
								<td>由insertDate来决定。格式为『YY/MM/DD HH:MM:SS』的日期字符串</td>
							</tr>
							
						</tbody>
					</table>
					<h3>创建DataManager</h3>
					<p>首先，为了对DataModel进行管理，我们需要先创建一个ToDoManager。</p>
					<pre><code>// 制作dataModelManager"ToDoManager"
var todoManager = h5.core.data.createManager('ToDoManager');</code></pre>
					<h3>创建DataModel</h3>
					<p>在schema定义的基础上，使用ToDoManager来创建了数据模型ToDoModel，并且将它设置为全局变量：sample.todo.model.ToDoModel。</p>
					<pre><code>// 生成dataModel
var todoModel = todoManager.createModel({
    name: 'TodoModel',
    schema: {
        // ID
        id: {
            id: true,
            type: 'integer'
        },
        // 状态
        status: {
            type: 'boolean'
        },
        checked: {
            type: 'string',
            depend: {
                on: 'status',
                calc: function() {
                    return this.get('status') ? 'checked' : null;
                }
            }
        },
        // 内容
        content: {
            type: 'string'
        },
        // 内容 - 样式
        contentStyle: {
            type: 'string',
            depend: {
                on: 'status',
                calc: function() {
                    return this.get('status') ? 'line-through' : '';
                }
            }
        },
        // 登陆日
        insertDate: {
            type: 'number'
        },
        // 登陆日 - 详细表示用
        ymdhms: {
            type: 'string',
            depend: {
                on: 'insertDate',
                calc: function() {
                    return toYMDHMS(this.get('insertDate'));
                }
            }
        }
    }
});

// sample.todo.model.ToDoModel 暴露到全局中
h5.u.obj.expose('sample.todo.model', {
    ToDoModel: todoModel
});</code></pre>
					<p>然后，创建了将在数据模型中使用的函数toYMDHMS。</p>
					<pre><code>function toYMDHMS(value) {
    var date = new Date(value);
    var mm = date.getMonth() + 1;
    var dd = date.getDate();
    var hh = date.getHours();
    var mi = date.getMinutes();
    var ss = date.getSeconds();

    if (mm < 10) {
        mm = '0' + mm;
    }
    if (dd < 10) {
        dd = '0' + dd;
    }
    if (hh < 10) {
        hh = '0' + hh;
    }
    if (mi < 10) {
        mi = '0' + mi;
    }
    if (ss < 10) {
        ss = '0' + ss;
    }

    return date.getFullYear() + '/' + mm + '/' + dd + ' ' + hh + ':' + mi + ':' + ss;
}</code></pre>
					<p>DataModel的创建如上所示。
在下一节中，我们将创建用来显示数据模型结果的视图。</p>
					<h2>创建视图</h2>
					<h3>概要</h3>
					<p>在上一节中，我们定义了数据模型，接下来我们将创建视图（画面）。
这一节中我们将对index.html中的代码进行说明。</p>
					<h3>视图的组成</h3>
					<p>我们把功能大致划分为以下3个：</p>
					<ul class="space">
						<li>1.用来更新登录TODO的Form。</li>
						<li>2.用来显示TODO一览的列表。</li>
						<li>3.用来显示和修改TODO详细信息的画面。</li>
					</ul>
					<p>预想将构造下面这样的画面。</p>
					<img src="../images/todo_view (1).png" alt="" />
					<p>将数据模型在视图中反映出来，并非是在Controller中对DOM进行操作，
而是通过使用视图绑定中的注释视图与ObservableArray的功能，实现自动反映在视图中。</p>
					<h3>代码例子</h3>
					<p><strong>创建HTML页面，如下所示：</strong></p>
					<pre><code>&lt;!doctype html&gt;
&lt;html lang="ja"&gt;
&lt;head&gt;
    &lt;meta charset="UTF-8"&gt;
    &lt;meta name="viewport" content="width=device-width,minimum-scale=1,maximum-scale=1"&gt;
    &lt;link rel="stylesheet" href="../archives/current/h5.css" /&gt;
    &lt;link rel="stylesheet" href="css/index.css" /&gt;
    &lt;script src="../res/lib/jquery/jquery.js"&gt;&lt;/script&gt;
    &lt;script src="../archives/current/h5.dev.js"&gt;&lt;/script&gt;
    &lt;script src="js/todoModel.js"&gt;&lt;/script&gt;
    &lt;script src="js/todoLogic.js"&gt;&lt;/script&gt;
    &lt;script src="js/todoController.js"&gt;&lt;/script&gt;
    &lt;script src="js/init.js"&gt;&lt;/script&gt;
    &lt;title&gt;TODO管理&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;div id="content" class="content"&gt;
        &lt;div class="header"&gt;
            &lt;form id="todoRegForm"&gt;
                &lt;div class="todo-form corner-all box"&gt;
                    &lt;div class="todo-form-right"&gt;
                        &lt;input type="button" id="btnRegist" class="corner-all ui-button gray" value="登録" tabindex="2"&gt;
                    &lt;/div&gt;
                    &lt;div class="todo-form-left"&gt;
                        &lt;input type="text" id="txtTodo" class="corner-all ui-text txt-todo" placeholder="TODO" tabindex="1"&gt;
                    &lt;/div&gt;
                &lt;/div&gt;
            &lt;/form&gt;
        &lt;/div&gt;
        &lt;div class="top"&gt;
        &lt;!--{h5view id="tmplTodos"}
            &lt;table class="todo-list" id="list"&gt;
                &lt;thead&gt;
                    &lt;tr&gt;&lt;th&gt;&nbsp;&lt;/th&gt;&lt;th&gt;内容&lt;/th&gt;&lt;/tr&gt;
                &lt;/thead&gt;
                &lt;tbody data-h5-loop-context="todos"&gt;
                    &lt;tr&gt;
                        &lt;td class="status"&gt;
                            &lt;input type="hidden" data-h5-bind="id" /&gt;
                            &lt;input type="checkbox" class="ui-check" data-h5-bind="attr(checked):checked"/&gt;
                        &lt;/td&gt;
                        &lt;td class="content"&gt;
                            &lt;span data-h5-bind="content;style(text-decoration):contentStyle"&gt;&lt;/span&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;
                &lt;/tbody&gt;
            &lt;/table&gt;
        --&gt;
        &lt;/div&gt;
        &lt;div class="bottom"&gt;
        &lt;!--{h5view id="tmplDetail"}
            &lt;form id="detailForm" class="form-detail" data-h5-loop-context="detail"&gt;
                &lt;table class="tbl-detail"&gt;
                    &lt;tr>
                        &lt;th&gt;登録日:&lt;/th&gt;
                        &lt;td&gt;
                            &lt;span data-h5-bind="ymdhms"&gt;&lt;/span&gt;
                            &lt;input type="hidden" name="id" data-h5-bind="id"/&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;th&gt;TODO:&lt;/th&gt;
                        &lt;td&gt;&lt;input type="text" name="content" class="ui-text" data-h5-bind="content" /&gt;&lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;th&gt;完了:&lt;/th&gt;
                        &lt;td&gt;&lt;input type="checkbox" name="status" class="ui-check" data-h5-bind="attr(checked):checked"/&gt;&lt;/td&gt;
                    &lt;/tr&gt;
                    &lt;tr&gt;
                        &lt;td colspan="2"&gt;
                            &lt;div class="div-btn-space"&gt;&lt;input type="button" id="btnUpdate" class="corner-all ui-button gray" value="更新" /&gt;&lt;/div&gt;
                            &lt;div class="div-btn-space"&gt;&lt;input type="button" id="btnDel" class="corner-all ui-button gray" value="削除" /&gt;&lt;/div&gt;
                        &lt;/td&gt;
                    &lt;/tr&gt;
                &lt;/table&gt;
            &lt;/form&gt;
        --&gt;
        &lt;/div&gt;
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
					<p>在注释中有2个地方写着。这就是使用了注释视图中的技能注释模板。
注释最前头写着的id=tmplTodos与id=tmplDetail，是在DataModel与模板绑定时，用来区分使用了哪个模板。</p>
					<h2>创建逻辑</h2>
					<h3>概要</h3>
					<p>在这一节中，我们将对数据模型ToDoModel中的DataItem的插入、更新、删除等操作进行编码。
这里封装好的方法，会在下一节创建的Controller中使用。
这一节将对例子todoLogic.js的代码进行说明。</p>
					<h3>Logic的组成</h3>
					<p>为了操作TodoModel创建了逻辑ToDoLogic。 <br />
TodoLogic中的方法如下：</p>
					<table>
						<thead>
							<tr>
								<th>方法名</th>
								<th>返回值</th>
								<th>说明</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>init()</td>
								<td>void</td>
								<td>从服务器上取得TODO的数据（例子是通过读取json文件）</td>
							</tr>
							<tr>
								<td>getItem(Number id)</td>
								<td>DataItem</td>
								<td>取得指定ID的DataItem</td>
							</tr>
							<tr>
								<td>add(String content)</td>
								<td>void</td>
								<td>将TODO的内容插入到DataModel中</td>
							</tr>
							<tr>
								<td>remove(Nubmer id)</td>
								<td>void</td>
								<td>删除指定ID的DataItem</td>
							</tr>
							<tr>
								<td>update(id, data)</td>
								<td>void</td>
								<td>更新指定ID的DataItem</td>
							</tr>
							<tr>
								<td>getDetail(Number id)</td>
								<td>ObservableArray[DataItem]</td>
								<td>取得指定ID的DataItem数组</td>
							</tr>
						</tbody>
					</table>
					<p>而ToDoLogic的属性如下所示：</p>
					<table>
						<thead>
							<tr>
								<th>属性名</th>
								<th>类型</th>
								<th>说明</th>
							</tr>
						</thead>
						<tbody>
							<tr>
								<td>model</td>
								<td>DataModel</td>
								<td>sample.todo.model.ToDoModel</td>
							</tr>
							<tr>
								<td>todos</td>
								<td>ObservableArray[DataItem]</td>
								<td>用来显示一览的DataItem的ObservableArray对象</td>
							</tr>
							<tr>
								<td>detail</td>
								<td>ObservableArray[DataItem]</td>
								<td>用来显示详细信息的DataItem的ObservableArray对象</td>
							</tr>
						</tbody>
					</table>
					<p>为了显示TODO一览，我们将相应的数组通过注释模板tmplTodos中的data-h5-loop-context="todos"进行了绑定。
而为了显示TODO详细信息，我们将相应的数组通过注释模板tmplDetail中的data-h5-loop-context="detail"进行了绑定。
通过ObservableArray对象进行绑定后，对数组的操作（插入、更新或者删除）时，都会自动在视图中反映出来。</p>
					<h3>代码例子</h3>
					<p>ToDoLogic的代码如下：</p>
					<pre><code>var SAMPLE_DATA_FILEPATH = 'json/sampleData.json';


var todoLogic = {
    __name: 'sample.todo.logic.TodoLogic',


    /**
     * TODO模型
     */
    model : sample.todo.model.ToDoModel,

    /**
     * 一览表示用ObservableArray
     */
    todos : h5.core.data.createObservableArray(),

    /** 
     * 详细表示用ObservableArray
     */
    detail : h5.core.data.createObservableArray(),

    /**
     * 从服务器取得todo数据
     * 
     * ※读取json文件的sample数据
     *
     * @returns {Promise} Promise对象
     */
    init: function() {
        var df = this.deferred();
        var that = this;

        $.ajax({
            url: SAMPLE_DATA_FILEPATH,
            dataType: 'json',
            cache: false,
            success: function(data) {
                var dataItems = that.model.create(data);
                that.todos.copyFrom(dataItems);
                df.resolve(that.todos);
            },
            error: function() {
                alert('读取sample数据失败');
            }
        });

        return df.promise();
    },
    /**
     * 取得指定ID的dataItem
     *
     * @return {DataItem} TODO的dataItem
     */
    getItem: function(id) {
        return this.model.get(id);
    },
    /**
     * 注册todo模型的数据，添加一览表示的数组item
     *
     * @param content {String} TODO内容
     */
    add: function(content) {
        var item = this.model.create({
            id: this._getNewId(),
            status: false,
            content: content,
            insertDate: +new Date()
        });

        this.todos.push(item);
    },
    /**
     * 根据指定的itemID，从模型中删除dataItem
     *
     * @param id {Number} item ID
     */
    remove: function(id) {
        for ( var i = 0, len = this.todos.length; i < len; i++) {
            var item = this.todos[i];
            var itemId = item.get('id');

            if (itemId === id) {
                this.model.remove(id);
                this.todos.splice(i, 1);
                this.detail.pop();
                break;
            }
        }
    },
    /**
     * 根据指定的itemID,更新dataItem
     *
     * @param id {Number} itemID
     * @param data {Object} 更新数据
     */
    update: function(id, data) {
        var item = this.model.get(id);
        item.set(data);
    },
    /**
     * 根据指定的itemID,取得dataItem的数组
     *
     * @param id {Number} item ID
     * @returns ObservableArray
     */
    getDetail: function(id) {
        var item = this.model.get(id);
        this.detail.splice(0, 1, item);
        return this.detail;
    },
    /**
     * 取出dataItem的ID值
     *
     * @returns {Number} itemID
     */
    _getNewId: function() {
        for ( var i = 1;; i++) {
            if (!this.model.has(i)) {
                return i;
            }
        }
    }
};

// sample.todo.logic.ToDoLogic 暴露到全局中
h5.core.expose(todoLogic);</code></pre>
					<h2>创建控制器</h2>
					<h3>概要</h3>
					<p>在这一节中，我们将创建TODO应用的Controller。实现对视图中定义的按钮、表格等元素进行相应的处理。
这里，Controller会使用前面所创建好的Logic，来实现数据的插入、更新和删除。
现在，我们将把todoController.js代码作为例子进行说明。</p>
					<h3>Controller的组成</h3>
					<p>控制器ToDoController，将包含了以下处理：</p>
					<ul class="space">
						<li><strong>TODO插入表格</strong>
							<ul>
								<li>・ 点击登录按钮，TODO文本框中的值将被登录到DataModel中。</li>
								<li>・ 在TODO文本框中按下Enter键，TODO文本框中的值将被登录到DataModel中。</li>
							</ul>
						</li>
						<li><strong>TODO一览</strong>
							<ul>
								<li>・ 点击表格的任一一行，表格下会显示出该行的详细信息。</li>
								<li>・ 点击checkbox，对应的status会进行更新。</li>
								<li>・ 将任一一行的checkbox勾选时，相应的TODO内容上会出现删除线。</li>
							</ul>
						</li>
						<li><strong>TODO详细信息</strong>
							<ul>
								<li>・ 点击删除按钮，现在显示的DataItem信息将从ToDoModel中删除掉，并反映到画面中。</li>
								<li>・ 点击更新按钮，对应的DataItem的值将被画面表格中相应的值所替换。</li>
							</ul>
						</li>
					</ul>
					<p>在生命周期的__ready阶段，ToDoLogic会通过执行init()函数来获取TODO数据，并与注释视图相绑定。</p>
					<h3>代码例子</h3>
					<p>ToDoController的代码如下所示：</p>
					<pre><code>var todoController = {
    __name: 'sample.todo.controller.TodoController',
    todoLogic: sample.todo.logic.TodoLogic,
    /**
     * 把todoList的数据从服务器取出表现在画面上
     * 
     * ※从Json文件中获取sample数据
     */
    __ready: function() {
        var that = this;

        this.todoLogic.init().done(function(data) {
            that.view.bind('h5view#tmplTodos', {
                todos: data
            });
        });
    },
    /**
     * 按下登录按钮时候的处理
     * 
     *
     * @param {Object} context 事件内容
     */
    '#btnRegist click': function(context) {
        this._insertToDo(context);
    },
    /**
     * 提交todo文本框的内容时候的处理
     * 
     *
     * @param {Object} context 
     */
    '#todoRegForm submit': function(context) {
        this._insertToDo(context);
    },
    /**
     * 操作todoList一览的CheckBox时候的处理
     * 
     * 根据CheckBox的值，更新dataItem的状态
     *
     * @param {Object} context 
     */
    '#list tbody input[type="checkbox"] click': function(context) {
        var target = context.event.currentTarget;
        var id = this._getSelectedItemId($(target).closest('tr'));
        var status = target.checked;

        this.todoLogic.update(id, {
            status: status
        });

        context.event.stopPropagation();
    },
    /**
     * 表示选择行的todo的详细内容
     *
     * @param {Object} context 
     */
    '#list tbody tr click': function(context) {
        var that = this;
        var id = this._getSelectedItemId(context.event.currentTarget);
        var detail = this.todoLogic.getDetail(id);

        if ($('#detailForm').children().length === 0) {
            this.view.bind('h5view#tmplDetail', {
                detail: detail
            });
        }

        // 详细画面的移动
        setTimeout(function() {
            window.scrollTo(0, that.$find('#detailForm').offset().top);
        }, 100);
    },
    /**
     *
     * 提交详细画面文本框内容时候的处理
     * 
     *
     * @param {Object} context 
     */
    '#detailForm submit': function(context) {
        // 阻止表单提交的默认行为
        context.event.preventDefault();
    },
    /**
     * 按下删除按钮时候的处理
     * 删除表示详细画面的todo数据
     *
     * @param {Object} context 
     */
    '#btnDel click': function(context) {
        var params = this._getFormData();

        this.todoLogic.remove(parseInt(params.id));

        // 阻止表单提交的默认行为
        context.event.stopPropagation();
        // 移动到页面的顶部
        h5.ui.scrollToTop();
    },
    /**
     * 按下更新按钮时的处理
     * 
     * 更新详细画面出现的todo数据
     *
     * @param {Object} context
     */
    '#btnUpdate click': function(context) {
        var params = this._getFormData();

        this.todoLogic.update(params.id, {
            content: params.content,
            status: !!params.status
        });

        // 阻止表单提交的默认行为
        context.event.stopPropagation();
        // 移动到页面的头部
        h5.ui.scrollToTop();
    },
    /**
     * 提交todo数据的处理
     *
     * @param {Object} ctx 
     */
    _insertToDo: function(ctx) {
        var $txtTodo = this.$find('#txtTodo');

        if ($txtTodo.val() === '') {
            alert('没有输入todo的值');
        } else {
            this.todoLogic.add($txtTodo.val());
            $txtTodo.val('');
        }

        // 阻止表单提交的默认行为
        ctx.event.preventDefault();
    },
    /**
     * 从一览中取得选择行的item的ID
     *
     * @param targetElem {DOMElement} 事件发生元素
     * @returns item ID
     */
    _getSelectedItemId: function(targetElem) {
        return $(targetElem).find('input[data-h5-bind="id"]').val();
    },
    /**
     * 取得详细画面的输入值
     *
     * @returns {Object} 输入值储藏的对象
     */
    _getFormData: function() {
        var param = {};

        $.each(this.$find('#detailForm').serializeArray(), function(i, obj) {
            param[obj.name] = obj.value;
        });

        return param;
    }
};

// sample.todo.controller.ToDoController公开到全局中
h5.core.expose(todoController);</code></pre>
					<p>最后，通过h5.core.controller()方法将DOM元素与sample.todo.controller.ToDoController绑定起来。</p>
					<h3>Controller的绑定</h3>
					<p>到这里，我们就完成了整个应用中的DataModel、View、Logic、Controller的创建。
接下来，通过执行下面的代码，将DOM元素和Controller绑定起来，使得TODO管理应用正常运行起来。</p>
					<pre><code>h5.core.controller('#content', sample.todo.controller.TodoController);</code></pre>
					<h1>schedule管理概要</h1>
					<h2>概要</h2>
					<blockquote>
						<p>为了巩固一下关于hifive框架的练习，在这边新增加了一个schedule管理的介绍。schedule管理在todo应用的基础上添加了一些hifive中常用的api,它是一个展示当前时间月份以及在每一天都一个日程管理的一个小的sample。点击日期就可以查看或者追加当天的任务管理。
						由于schedule管理的内容较多，在这里就只做一些简单的介绍。<a href="../sample/schedule.rar">点击这里下载</a>完整项目文件包，大家可以通过下载下来的项目中查看完整的代码。
						</p>
					</blockquote>
					<h2>动作确认</h2>
					<p>点击<a href="../sample/schedule/index.html">这里</a>来查看应用</p>
					<img src="../images/schedule.png"/>
				</article>
								<!--返回首页按钮-->
			<input class="btn" type="button" name="" id="" value="返回首页" />
			<!--跳转到下一章节-->
			<input class="btn1" type="button" name="" id="" value="下一章节" />
			<!-- 返回顶部按钮 -->
			<div class="backTop"></div>
			</div>
		</div>
	</body>

</html>
<script type="text/javascript" src="../lib/toc/js/jquery-1.4.4.min.js"></script>
<script type="text/javascript" src="../lib/toc/js/jquery.ztree.all-3.5.min.js"></script>
<script type="text/javascript" src="../lib/toc/js/ztree_toc.js"></script>
<script type="text/javascript" src="../lib/toc_conf.js"></script>
<script type="text/javascript" src="../js/common.js"></script>
<script>
	$('.btn1').click(function(){
		location.href='./hifiveApi.html';
	})
</script>
